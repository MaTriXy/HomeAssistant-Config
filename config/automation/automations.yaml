##############################################################################   
#
# Set Day Mode Theme on Start
#
##############################################################################   
# - alias: 'Set Day theme at startup'
#   initial_state: 'on'
#   hide_entity: true
#   trigger:
#   - platform: homeassistant
#     event: start
#   condition:
#     condition: sun
#     after: sunrise
#     after_offset: '+00:30:00'
#   action:
#   - service: frontend.set_theme
#     data:
#       name: badge #same like the defualt But with Badge color gray
##############################################################################   
#
# Set Night Mode Theme on Start
#
##############################################################################   
# - alias: 'Set Night theme at startup'
#   initial_state: 'on'
#   hide_entity: true
#   trigger:
#   - platform: homeassistant
#     event: start
#   condition:
#     condition: sun
#     after: sunset
#     after_offset: '+00:30:00'
#   action:
#   - service: frontend.set_theme
#     data:
#       name: dark-mode
##############################################################################   
#
# Set Day Mode Theme
#
##############################################################################   
# - alias: 'Set Day Mode Theme after Sunrise'
#   initial_state: 'on'
#   hide_entity: true
#   trigger:
#   - platform: sun
#     event: sunrise
#     offset: '+00:30:00'
#   action:
#   - service: frontend.set_theme
#     data:
#       name: badge #same like the defualt But with Badge color gray
##############################################################################   
#
# Set Night Mode Theme
#
##############################################################################   
# - alias: 'Set Night Mode Theme after Sunset'
#   initial_state: 'on'
#   hide_entity: true
#   trigger:
#   - platform: sun
#     event: sunset
#     offset: '+00:45:00'
#   action:
#   - service: frontend.set_theme
#     data:
#       name: dark-mode
##############################################################################   
#
# Update Available Notifications
#
##############################################################################   
- alias: 'Update Available Notifications'
  hide_entity: true
  trigger:
    platform: state
    entity_id: updater.updater
  action:
    service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
    data:
      title: 'Updater'
      message: ' עדכון תוכנה זמין !!!'   #Update for Home Assistant is available
##############################################################################   
#
# HA Startup up and running Notification
#
##############################################################################   
- alias: 'Startup Notification'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram 
      data:
        title: 'System info'
        message: 'Home Assistant is Up and Running.'
        data:
          #iOS Only
          attachment: 
            url: https://i.imgur.com/ZWIytcC.png 
            #https://community-home-assistant-assets.s3-us-west-2.amazonaws.com/original/2X/6/6a99ebb8d0b585a00b407123ff76964cb3e18780.png
            
    - service: camera.local_file_update_file_path
      data:
        entity_id: camera.cctv1_snapshot #use the latest snapshot 
        file_path: '/config/tmp/clean.png'
    - delay: 0:02:00 # to wait all componets will work good
    # - service: shell_command.start_homebridge #not in use - using buidin homekit
    - service: mqtt.publish 
      data:
        topic: "cmnd/sonoffs/state" #Update the power state of all the sonoffs
        payload: ""
    - service: mqtt.publish
      data:
        topic: cmnd/sonoffs/POWER
    - service: mqtt.publish
      data:
        topic: cmnd/sonoffs/POWER2
    - service: mqtt.publish
      data:
        topic: cmnd/sonoffs/POWER3                  
    # - service: mqtt.publish
    #   data:
    #     topic: 'cmnd/sonoff_ifan/FanSpeed'
    #     payload: ''
    # - service: mqtt.publish
    #   data:
    #     topic: 'BlueIris/#'
    #     payload: ''        
############################################################
#
# Notify when error in HA config
#
############################################################ 
- alias: 'Notify when error in config'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: persistent_notification.homeassistantcheck_config
    to: 'notifying'
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'Home Assistant'
      message: 'Config error. See dev-info panel for details.'
      data:
        attachment: 
          url: https://i.imgur.com/JaIaGk1.png
          #https://png.icons8.com/nolan/1600/source-code.png


##############################################################################   
#
# Xiaomi CCTV Offline 
#
##############################################################################   
# - alias: 'Hikvision CCTV Offline'
#   initial_state: 'off' #Working good! but not in use
#   trigger:
#     platform: state
#     entity_id: switch.sonoff_xiaomicctv_switch
#     to: 'off'
#     for:
#       minutes: 1
#   action:
#     - service: notify.elirantur2
#       data:
#         title: "מצלמת הסלון"   #Living room CCTV
#         message: 'במצב כבוי'   # Turn Off
#         data:
#           push:
#               badge: 0
#               category: 'modifymycctvswitch' #the indentefier
#          # attachment: 
#          #   url: https://i2.wp.com/etnasasta.com/wp-content/uploads/2018/02/ce677824-4a52-4eeb-b334-ab4801d606ef.gif
##############################################################################   
#
# Hkvision CCTV online and someone at home
#
##############################################################################   
- alias: 'Hikvision CCTV is on alert'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.sonoff_xiaomicctv_switch
    to: 'on'
    for:
      minutes: 1
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'home'
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'מצלמת הסלון'   #Living room CCTV
        message: 'במצב דלוק,בדוק את סיבת ההדלקה'# Turn Off
        data:
          push:
              badge: 0
              category: 'modifymycctvswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/NfTLZfH.gif
            #https://mykharkov.info/wp-content/uploads/2015/03/camera_spying_big_brother_500_clr_4265.gif
##############################################################################   
#
# home CCTV Offline
#
##############################################################################   
# - alias: 'Home CCTV Offline'
#   initial_state: 'off' # Working good but not in use
#   trigger:
#     platform: state
#     entity_id: switch.mqtt_pow2
#     to: 'off'
#     for:
#       minutes: 1
#   action:
#     service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
#     data:
#       title: "מצלמת המטבח"  #Kitchen CCTV
#       message: 'במצב כבוי'  #is Off
#       data:
#         push:
#           badge: 0
#           category: 'modifymycctvswitch' #the indentefier
#         attachment: 
#           url: http://fb1-cw.lnwfile.com/lgx068.png
##############################################################################   
#
# home CCTV online and someone at home
#
##############################################################################   
- alias: 'home CCTV is on alert'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow2
    to: 'on'
    for:
      minutes: 1
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'home'
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'מצלמת המטבח' #Living room CCTV
        message: 'במצב דלוק,בדוק את סיבת ההדלקה'# Turn Off
        data:
          push:
              badge: 0
              category: 'modifymycctvswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/NfTLZfH.gif
##############################################################################   
#
# Xiaomi GateWayOffline
#
##############################################################################   
- alias: 'Xiaomi GateWay Offline'
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: device_tracker.xiaomigateway
    to: 'not_home'
    for:
      minutes: 2
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'רכזת שואמי'   #Xiaomi Gateway
      message: 'הרכזת לא מחוברת לרשת' #is Offline
      data:
        attachment: 
          url: https://i.imgur.com/9S9HpDi.png
          #http://mycarcamera.ru/wp-content/uploads/2016/06/migateway-st-05.png
##############################################################################   
#
# turn ON CCTV cameras if late Night
#
##############################################################################   
- alias: 'turn ON CCTV cameras if late Night'
  initial_state: 'on'
  trigger:
    platform: time
    at: '02:00:00'
    # When 'at' is used, you cannot also match on hour, minute, seconds.
    # Military time format.
  action:
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow2 #homeCCTV
    - service: homeassistant.turn_on
      entity_id: switch.sonoff_xiaomicctv_switch
      
    - service: automation.turn_off #disable autiomation
      data:
        entity_id: automation.turn_off_cctv_cameras_if_eliran_at_home
    - service: automation.turn_off #disable autiomation
      data:
        entity_id: automation.turn_off_cctv_cameras_if_shiran_at_home
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'אבטחה'  #Security 
        message:  'השעה 2 בלילה,מצלמות הבית דלוקות'  #the time is 2AM CCTV's are on
        data:
          attachment: 
            url: https://i.imgur.com/XyOT3VR.png
            #https://i.pinimg.com/originals/8c/42/d4/8c42d426f7fef619b2e4ee6f9eae6c0d.jpg
##############################################################################   
#
# turn OFF CCTV cameras if Morning and we are at home -Need Some Testing!!!
#
##############################################################################   
- alias:  'turn OFF CCTV cameras if Morning and we are at home'
  initial_state: 'on'
  trigger:
    - platform: time
      at: '06:30:00'
      # When 'at' is used, you cannot also match on hour, minute, seconds.
      # Military time format.
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi
        state: 'home'

  action:
    - service: homeassistant.turn_off
      entity_id: switch.mqtt_pow2 #homeCCTV
    - service: homeassistant.turn_off
      entity_id: switch.sonoff_xiaomicctv_switch
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'אבטחה'  #security
        message: 'השעה 6:30 בבוקר, אם אתם בבית ,המצלמות יכבו'  #The time is 6:30AM if someone at home -CCTV OFF
        data:
          push:
              badge: 0
              category: 'modifymycctvswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/W6ICkDd.png

##############################################################################   
#
# turn OFF CCTV cameras if Morning and we are at home -Need Some Testing!!!
#
##############################################################################   
- alias: 'enable Automation 630 AM'
  initial_state: 'on'
  trigger:
    - platform: time
      at: '06:29:00'
  action:
    - service: automation.turn_on #enable automation
      data:
        entity_id: automation.turn_off_cctv_cameras_if_eliran_at_home
    - service: automation.turn_on #enable automation
      data:
        entity_id: automation.turn_off_cctv_cameras_if_shiran_at_home
##############################################################################   
#
# turn off CCTV cameras if shiran at home
#
##############################################################################   
- alias:  'turn off CCTV cameras if shiran at home'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: device_tracker.shiran_iphone_wifi
    to: 'home'
    # If given, will trigger when state has been the to state for X time.
    for:
      minutes: 1
      seconds: 30
  action:
    - service: homeassistant.turn_off
      entity_id: switch.mqtt_pow2 #homeCCTV
    - service: homeassistant.turn_off
      entity_id: switch.sonoff_xiaomicctv_switch

    - service: notify.ios_shiran_iphone
      data:
        title: 'אבטחה'   #securty
        message: 'ברוך הבא שירן :) מצלמות הבית כבויות'   #Welcome Home Shiran , CCTV off
        data:
          push:
            sound: "US-EN-Morgan-Freeman-Welcome-Home.wav"
            badge: 0
            category: 'modifymycctvswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/W6ICkDd.png

##############################################################################   
#
# turn off CCTV cameras if Eliran at home
#
##############################################################################   
- alias:  'turn off CCTV cameras if Eliran at home'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: device_tracker.eliran_iphone_wifi
    to: 'home'
    # If given, will trigger when state has been the to state for X time.
    for:
      minutes: 1
      seconds: 30
  action:
    - service: homeassistant.turn_off
      entity_id: switch.mqtt_pow2 #homeCCTV
    - service: homeassistant.turn_off
      entity_id: switch.sonoff_xiaomicctv_switch

    - service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
      data:
        title: 'אבטחה' #security
        message: 'ברוך הבא אלירן :) מצלמות הבית כבויות'  #Welcome Home Eliranc, CCTV off
        data:
          push:
            sound: "US-EN-Morgan-Freeman-Welcome-Home.wav"
            badge: 0
            category: 'modifymycctvswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/W6ICkDd.png

##############################################################################   
#
# turn ON CCTV cameras if eliran and shiran not at home
#
##############################################################################   
- alias:  'turn on CCTV cameras if eliran AND shiran NOT at home'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: device_tracker.eliran_iphone_wifi,device_tracker.shiran_iphone_wifi
      to: 'not_home'
      # If given, will trigger when state has been the to state for X time.
      for:
        minutes: 1
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi
        state: 'not_home'
  action:
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow2 #homeCCTV
    - service: homeassistant.turn_on
      entity_id: switch.sonoff_xiaomicctv_switch
##############################################################################   
#
# cameras and gateway are online 
#
##############################################################################   
- alias: 'Security status' #TODO make sure all setup
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_main_entrance
    from: 'on'
    to: 'off'
    for:
      minutes: 5
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
      - condition: state
        entity_id: switch.mqtt_pow2 #home CCTV
        state: 'on'
      - condition: state
        entity_id: switch.sonoff_xiaomicctv_switch
        state: 'on'
      - condition: state
        entity_id: device_tracker.ipc_10 #by Ping     #hikvision_outdoor_cctv_01 #By WRT
        state: 'home'
      - condition: state
        entity_id: device_tracker.xiaomigateway
        state: 'home'
      - condition: state
        entity_id: device_tracker.windows_vm #serverpc Eliran
        state: 'home'        
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'אבטחה'
      message: 'כל המצלמות והחיישנים פועלים!'
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Front-Door-Locked.wav"
        attachment: 
          url: https://i.imgur.com/EKlDln1.gif
          #https://www.trendmicro.com/azure/wp-content/uploads/2016/05/TM_Lock_Sequence_300x300_Looping.gif

##############################################################################   
#
# security warning door open Unauthorised 
# 
##############################################################################  
#Realy Cool Automation ,if Door open Send a Notification with live stream CCTV and save a snapshot from the CCTV
- alias: 'security warning door open unauthorised '
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_main_entrance
    from: 'on'
    to: 'off'
    for:
      seconds: 15
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
  action:
  # - service: rest_command.set_preset_1_homecctv01 #move the camera to the main door.
  # - delay: 0:00:03 #give time to the camera to move to the preset
  - service: camera.snapshot
    data:
      entity_id: camera.home_cctv1 #take snapshot with Exact time and save it 
      filename: '/config/tmp/home_cctv1_{{ now().strftime("%d%m%Y-%H%M%S") }}.png' 
  - service: camera.snapshot
    data:
      entity_id: camera.home_cctv1 #take snapshot to update the last snapshot to show in HA
      filename: '/config/tmp/home_cctv1.png'
      
  - service: camera.local_file_update_file_path
    data:
      entity_id: camera.cctv1_snapshot #use the latest snapshot 
      file_path: '/config/tmp/home_cctv1.png'
  - service: rest_command.update_homecctv01_state #update the status of the camera to recording.
  - service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
    data:
      title: 'אבטחה' #securty
      message: 'דלת הבית נפתחה לפני 15 שניות, אנא וודא שהכניסה מאושרת!!!'  #Front Door was open 15 sec ago , Check if Unauthorised
      data:
        #iOS Only
        attachment:
          content-type: jpeg
        push:
          sound: "US-EN-Morgan-Freeman-Front-Door-Opened.wav"
          category: camera #PUSH THE CAMERA LIVE STREAM! :) 
        entity_id: camera.home_cctv1 
  - service: notify.mobile_app_smarthome_ipad
    data:
      title: 'אבטחה' #securty
      message: 'דלת הבית נפתחה לפני 15 שניות, אנא וודא שהכניסה מאושרת!!!'  #Front Door was open 15 sec ago , Check if Unauthorised
      data:
        #iOS Only
        attachment:
          content-type: jpeg
        push:
          sound: "US-EN-Morgan-Freeman-Front-Door-Opened.wav"
          category: camera #PUSH THE CAMERA LIVE STREAM! :) 
        entity_id: camera.home_cctv1         
        #iOS only End  

  - service: notify.eliran_telegram
    data:
      title: 'אבטחה' #securty
      message: 'דלת הבית נפתחה לפני 15 שניות, אנא וודא שהכניסה מאושרת!!!'  #Front Door was open 15 sec ago , Check if Unau
      data:
        photo:
          - file: /config/tmp/home_cctv1.png
            caption: '{{now().strftime("%Y.%m.%d-%H:%M:%S")}}'
  - delay: 0:15:00 # to hide the camera
  - service: group.set_visibility
    entity_id: group.security_notification
    data:
      visible: False
      

############################################################
#
# send notification upon failed login attempt
# if there was a login attempt with worng password , send Notification with URL and IP of the hacker ;)
############################################################
- alias: 'Send notification upon failed login attempt'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: persistent_notification.http_login
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'None' }}"
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data_template:
        title: 'בוצע נסיון כניסה שנכשל!'   #Failed login attempt!
        message: "{{ states.persistent_notification.http_login.attributes.message}}"
        #iOS only
        data:
          url: http://extreme-ip-lookup.com/{{ states.persistent_notification.http_login.attributes.message.split("from ") [1]}}
############################################################
#
# send notification upon IP BAN
# if there was a IP BAN , send Notification with URL and IP of the hacker ;)
############################################################
- alias: 'Send notification upon IP BAN'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: persistent_notification.ip_ban
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'None' }}"
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data_template:
        title: 'אייפיי נחסם!'   #Failed login attempt!
        message: "{{ states.persistent_notification.ip_ban.attributes.message}}"
        #iOS only
        data:
          url: http://extreme-ip-lookup.com/{{ states.persistent_notification.ip_ban.attributes.message.split("from ") [1]}}

##############################################################################  
#
# notify if the boiler turn ON
#
##############################################################################  
- alias:  'notify if the boiler turn ON'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow1
    to: 'on'
  action:
    - delay: 0:00:05 #to make sure the pow1_current get update
    - condition: numeric_state
      entity_id: 'sensor.pow1_current' #amper
      above: 5 #amper  
    - service: notify.shiran_and_eliran_ios
      data:
        title: 'דוד'
        message: 'הדוד דלוק!'
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier      
          attachment: 
            url: https://i.imgur.com/m0hzS2h.png
            #https://hasslefreeboilers.com/wp-content/uploads/2017/08/boilerman1.png
    - service: notify.eliran_telegram
      data:
        title: 'דוד'
        message: 'הדוד דלוק!'
##############################################################################  
#
# notify if the boiler turn ON improperly
#
##############################################################################  
- alias:  'notify if the boiler turn ON improperly'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow1
    to: 'on'
  action:
    - delay: 0:00:05 #to make sure the pow1_current get update
    - condition: numeric_state
      entity_id: 'sensor.pow1_current' 
      below: 5 #amper
    - service: notify.shiran_and_eliran_ios
      data:
        title: 'דוד'
        message: 'הדוד מכובה מהשקע הפיזי,נא הדלק לפני שימוש!'
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier      
          attachment: 
            url: https://i.imgur.com/amLt6zz.png
    - service: notify.eliran_telegram
      data:
        title: 'דוד'
        message: 'הדוד מכובה מהשקע הפיזי,נא הדלק לפני שימוש!'
##############################################################################  
#
# notify if the boiler was on for more then 10 min
#
##############################################################################  
- alias:  'notify if the boiler was on for more then 10 min'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow1
    to: 'on'
    for:
      minutes: 5
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
      data:
        title: 'דוד' #boiler
        message: 'הדוד דלוק יותר מ10 דקות!' #the boiler is ON more then 10 min
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier       #for custom action from the notification
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif
            #http://boilerbooker.com/static/imgs/boilers3_2.gif
    - service: notify.eliran_telegram
      data:
        title: 'דוד'
        message: 'הדוד דלוק יותר מ5 דקות!'
##############################################################################  
#
# notify if the boiler turn OFF
#
##############################################################################  
- alias:  'notify if the boiler turn OFF'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow1
    from: 'on'
    to: 'off'
  action:
    - delay: 0:00:05 #to make sure the pow1_current get update
    - condition: numeric_state
      entity_id: 'sensor.pow1_current' 
      below: 5 #amper  
    - service: notify.shiran_and_eliran_ios
      data:
        title: 'דוד'  #boiler
        message: 'הדוד מכובה!' #the boiler is off
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif
    - service: notify.eliran_telegram
      data:
        title: 'דוד'
        message: 'הדוד מכובה!'          

##############################################################################  
#                                                  
# boiler on  clock       
#                                                  
##############################################################################  
- alias: 'notify when the boiler clock on start'
  initial_state: 'on'
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.boiler_on_clock_time_long.state }}'
  condition:
    condition: state
    entity_id: input_boolean.boiler_on_clock_status
    state: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow1
    - service: notify.shiran_and_eliran_ios
      data:
        title: 'דוד'  #boiler
        message: 'הדוד מכובה!' #the boiler is off
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif      
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'דוד' #boiler
        message: 'הדוד נדלק לפי השעון שהוגדר'  #the boiler is on 
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier        
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif
    # - service: notify.eliran_ios_and_ipad_and_telegram
    #   data:
    #     title: 'דוד' #boiler
    #     message: 'הדוד נדלק לפי השעון שהוגדר'  #the boiler is on 
    #     data:
    #       attachment: 
    #         url: https://i.imgur.com/igtwFWz.gif            
    - service: notify.eliran_telegram
      data:
        title: 'דוד'
        message: 'הדוד נדלק לפי השעון שהוגדר'  #the boiler is on 
##############################################################################  
#
# boiler off  clock
#
##############################################################################  
- alias: 'notify when the boiler clock off ended'
  initial_state: 'on'
  hide_entity: False
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.boiler_off_clock_time_long.state }}'
  condition:
    condition: state
    entity_id: input_boolean.boiler_off_clock_status
    state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id: switch.mqtt_pow1
    - delay: 0:00:03
    - service: homeassistant.turn_off
      entity_id: input_boolean.boiler_off_clock_status 
    - service: homeassistant.turn_off
      entity_id: input_boolean.boiler_on_clock_status
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'דוד' #boiler
        message: 'הדוד נכבה לפי השעון שהוגדר'  #the boiler is off
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier             
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif
##############################################################################  
#
# New Device online -new Device found via asus WRT device_tracker
#
##############################################################################  
- alias: 'Notify for new devices'
  initial_state: 'on'
  trigger:
  - platform: event
    event_type: device_tracker_new_device
  action:
      service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'Router'
        message: "New device is On-line Check if is authorized at known_devices.yaml"
        data:
          attachment: 
            url: https://i.imgur.com/FwVl0vM.png
            #https://servoy.com/wp-content/uploads/mutlidevices_small_forweb.png
##############################################################################  
#
# notify if the home door was open for more then 1 min
#
##############################################################################  
- alias:  'notify if the home door was open for more then 1 min'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_main_entrance
    from: 'off'
    to: 'on'
    for:
      minutes: 1
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'חישן הדלת'  #Front Door sensor
      message: 'דלת הבית פתוחה יותר מדקה' #front door is open more then 1 min
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Front-Door-Opened.wav"
        attachment: 
          url: https://i.imgur.com/O0BOOFA.gif
##############################################################################  
#
# Clicks type setup - Wall switch 1 (sofa)
#
############################################################################## 
# Toggle living room left light on single press
- alias: 'Toggle living room left light on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_left_158d0001712d0e
      click_type: single
  action:
    service: light.toggle
    entity_id: light.living_room_color_bulb
#Toggle living room right light on single press
- alias: 'Toggle living room right light on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_right_158d0001712d0e
      click_type: single
  action:
    service: light.toggle
    entity_id: light.white_bulb
#Toggle living room BOTH  on single press
- alias: 'Toggle living room BOTH  on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_both_158d0001712d0e
      click_type: both
  action:
    service: light.toggle
    entity_id: light.kitchen #kitchen light
##############################################################################  
#
# Clicks type setup - Wall switch 2 (MAIN enternce)
#
############################################################################## 
#Toggle livingRoom enternce left light on single press
- alias: 'Toggle livingRoom enternce left light on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_left_158d0001e119a7
      click_type: single
  action:
  - service: light.toggle
    entity_id: light.white_bulb
  - service: light.toggle
    entity_id: light.living_room_color_bulb
#Toggle livingRoom enternce right light on single press
- alias: 'Toggle livingRoom enternce right light on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_right_158d0001e119a7
      click_type: single
  action:
    service: light.toggle
    entity_id: light.kitchen
#Toggle livingRoom enternce BOTH  on single press
- alias: 'Toggle livingRoom enternce BOTH  on single press after 6AM'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_both_158d0001e119a7
      click_type: both
  condition:
    condition: time # TODO Needed?
    after: '06:00:01'
  action:
    service: homeassistant.turn_off
    entity_id: group.allmylights
    
#Toggle livingRoom enternce BOTH  on single press
- alias: 'Toggle livingRoom enternce BOTH  on single press after 6AM and turn off living room AC'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_both_158d0001e119a7
      click_type: both
  condition:
    condition: and
    conditions:
      - condition: time 
        after: '06:00:01'
      - condition: or
        conditions: #"operation_list": ["dry","auto","heat","fan_only","cool"]
          - condition: state 
            entity_id: climate.living_room
            state: 'dry' 
          - condition: state 
            entity_id: climate.living_room
            state: 'auto' 
          - condition: state 
            entity_id: climate.living_room
            state: 'heat' 
          - condition: state 
            entity_id: climate.living_room
            state: 'fan_only'  
          - condition: state 
            entity_id: climate.living_room
            state: 'cool'
  action:
    - service: climate.turn_off
      entity_id: climate.living_room
    - service: homeassistant.turn_off
      entity_id: group.allmylights    
##############################################################################
### Active only in the early morning
############################################################################## 
- alias: 'Toggle livingRoom enternce BOTH on single press early morning'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_both_158d0001e119a7
      click_type: both
  condition:
    condition: time #between 5AM-6AM
    after: '05:00:00'
    before: '06:00:00'
  action:
    - delay: 0:00:15  
    - service: homeassistant.turn_off
      entity_id: group.allmylights
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'בוקר טוב אלירן'
        message: "התאורה בבית כבויה, עבודה נעימה"
        data:
          attachment: 
            url: https://i.imgur.com/FqwVy2P.gif
          push:
            badge: 0
            category: 'modifymylights' #the indentefier


- alias: 'Turn On living room AC on livingRoom enternce BOTH click '
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_switch_both_158d0001e119a7
      click_type: both
  condition:
    condition: and
    conditions:
      - condition: state 
        entity_id: group.allmylights
        state: 'off'     
      - condition: state 
        entity_id: climate.living_room
        state: 'off'        
  action:
    - service: climate.turn_on
      entity_id: climate.living_room 
##############################################################################  
#
# Clicks setup - Bed roomSwitch
#
##############################################################################  
#####################
#  duoble click are set in mi-home app (toggel brighness level on desk lamp)
#####################
#Toggle Desk Lamp light on single press
- alias: 'Toggle Bedroom light on single press'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0000d8c836
      click_type: single
  action:
    service: light.toggle
    entity_id: light.bedroom
#turn off group.allmylights on long press roomSwitch
- alias: 'turn off group.allmylights on long press roomSwitch'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0000d8c836
      click_type: long_click_press
  action:
    service: light.turn_off
    entity_id: group.allmylights

##############################################################################  
#
# Klicks type setup -wall ROUNEDED switch
#
##############################################################################  
#Toggle living room lights on single press (ROUND) LivingRoomSwitch
- alias: 'Turn ON living room AC on single press LivingRoomSwitch'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000149b9ab
      click_type: single
  action:
  - service: climate.turn_on
    entity_id: climate.living_room


#Turn OFF living room AC on double click LivingRoomSwitch
- alias: 'Turn OFF living room AC on double click LivingRoomSwitch'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000149b9ab
      click_type: double
  action:
  - service: climate.turn_off
    entity_id: climate.living_room
    
#Set Max Volume S70PCI on long press LivingroomSwitch
- alias: 'Set Max Volume S70PCI on long press LivingroomSwitch'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000149b9ab
      click_type: long_click_press
  action:
    - service: media_player.volume_set
      entity_id: media_player.s70pci
      data_template:
        volume_level: '1.0' #0.0-1.0 min-max
  # action:
  #   service: media_player.volume_set
  #   entity_id: media_player.s70pci
  #   data_template: 
  #     volume_level: 1.0
  # action:
  #   - service: media_player.volume_set
  #     entity_id: media_player.s70pci
  #     volume_level: 1.0 


####################################################      
#                                                  #
# מפסקים מחליפים - הגדרה של טוגגל MAKLIF
#                                                  #
####################################################
#######
####### sonoff6
#######
- alias: 'Toggle Philips light on single press from sonoff6 2CH'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: light.special_sonoff_kitchen
    # to: ANYSTATE WAS CHANGE (ON/OFF)
  action:
    service: light.toggle
    entity_id: light.philips_bulb
##############################################################################  
#
#  'Notify when front door is open on TV' (on androidTV )
#
##############################################################################  
- alias: 'Notify when front door is open on TV'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_main_entrance
    from: 'off'
    to: 'on'
  action:
    service: notify.partner_tv #androidTV
    data:
      title: 'תורג׳מן הום'
      message: "דלת הבית פתוחה"
##############################################################################  
#
#  Hot temperature alert
#
##############################################################################  
- alias: 'Hot temperature alert bedroom'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.temperature_bedroom_0 #TEMP SENSOR
    # At least one of the following required
    above: 30
    # below: 25
  action:
    - service: homeassistant.turn_on
      entity_id: light.gateway_light
      data:
        brightness: 255
        rgb_color: [255,0,00] #RED
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'מד טמפרטורה'
        message: 'הטמפרטורה בחדר שינה מעל 30 מעלות'
        data:
          attachment: 
            url: https://i.imgur.com/5YfHCVy.gif
    - delay: 0:00:05
    - service: light.turn_off
      entity_id: light.gateway_light
          #https://cdn2.iconfinder.com/data/icons/coloured-weather-icon-set-svg/100/Coloured_Weather_Icon_Set_by_ViconsDesign-12-512.png
##############################################################################  
#
#  cold temperature alert
#
##############################################################################  
- alias: 'cold temperature alert bedroom' #only if Eliran/Shiran at home
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.temperature_bedroom_0 #tempsensor
    # At least one of the following required
    below: 16
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'home'    
  action:
  - service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'מד טמפרטורה'
      message: 'הטמפרטורה בחדר השינה ירדה מתחת ל16 מעלות'
      data:
        attachment: 
          url: https://i.imgur.com/8i3pK9L.png
          #https://cdn4.iconfinder.com/data/icons/weather-conditions/512/low_temperature-512.png
##############################################################################  
#
#  Hot temperature alert
#
##############################################################################  
- alias: 'Hot temperature alert LivingRoom'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.sensibo1_temp #TEMP SENSOR
    # At least one of the following required
    above: 30
    # below: 25
  action:
  - service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'מד טמפרטורה'
      message: 'הטמפרטורה בבית מעל 30 מעלות'
      data:
        attachment: 
          url: https://i.imgur.com/5YfHCVy.gif
          #https://cdn2.iconfinder.com/data/icons/coloured-weather-icon-set-svg/100/Coloured_Weather_Icon_Set_by_ViconsDesign-12-512.png
##############################################################################  
#
#  cold temperature alert
#
##############################################################################  
- alias: 'cold temperature alert LivingRoom'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.sensibo1_temp #tempsensor
    # At least one of the following required
    below: 18
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'home'       
  action:
  - service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'מד טמפרטורה'
      message: 'הטמפרטורה בבית ירדה מתחת ל18 מעלות'
      data:
        attachment: 
          url: https://i.imgur.com/8i3pK9L.png
          #https://cdn4.iconfinder.com/data/icons/weather-conditions/512/low_temperature-512.png
##############################################################################  
############################################################################## 
#
#  If there is motion and its dark turn on the gateway light -need some testing!
#
##############################################################################  
- alias: 'If there is motion and its dark turn on the gateway light'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.xiaomi_motion_sensor_hallway
    from: 'off'
    to: 'on'
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.xiaomi_gateway_illumination
        below: 300
      - condition: time
        after: '20:00:00'
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.eliran_iphone_wifi
            state: 'home'
          - condition: state
            entity_id: device_tracker.shiran_iphone_wifi #shiran
            state: 'home'
  action:
    - service: light.turn_on
      entity_id: light.gateway_light
      data:
        brightness: 10
    - delay: 0:00:35
    - service: light.turn_off
      entity_id: light.gateway_light
##############################################################################  
#
# alarm clock       
#
##############################################################################  
- alias: 'notify when the alarm is finish'
  initial_state: 'on'
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.alarm_clock_time_long.state }}'
  condition:
    condition: state
    entity_id: input_boolean.alarm_clock_status
    state: 'on'
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'שעון מעורר' #alarm clock
      message: 'שעון מעורר נגמר!'   #Alarm Clock is Finsh
      data:
        attachment: 
          url: https://i.imgur.com/lso7Poa.gif
          #https://cdn.dribbble.com/users/225481/screenshots/1114887/wekker-2.gif

####################################################
#                                                  #
# some of group.AllMylights still ON AT BEDTIME -Need testing      
#                                                  #
####################################################
- alias: 'some of "AllMylights" still ON AT BEDTIME '
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.eliran_iphone_battery_state
    to: 'Charging'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.AllMylights
        state: 'on'
      - condition: time
        after: '23:00:00'
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
      data:
        title: 'לילה טוב'
        message: "התאורה בבית דולקת האם ברצונך לכבות?"
        data:
          attachment: 
            url: https://i.imgur.com/FqwVy2P.gif
            #https://aeotec.com/images/products/nano_dimmer_new/lightbulb-compatibility.png            
          push:
            sound: "US-EN-Morgan-Freeman-Good-Night.wav"
            badge: 0
            category: 'modifymylights' #the indentefier
#####################################################
##                                                  #
## some of group.AllMylights is ON nobody at home -alert to turn it off
##                                                  #
#####################################################
- alias: 'some of group.AllMylights is ON and its Before Sunset'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.AllMylights #one of the light is on on more
      to: 'on'
      for:
        minutes: 40
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      message: 'חלק מאורות הבית נשכחו דלוקים'
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Turning-On-The-Mood-Lights.wav"
          badge: 0
          category: 'modifymylights' #the ID
        attachment: 
          url: https://i.imgur.com/f6np0J1.png
          #https://aeotec.com/images/products/nano_dimmer_new/lightbulb-compatibility.png

####################################################
#                                                  #
# Run the script daily to backup HASS config
#                                                  #
####################################################
- alias: 'Daily HASS Backup'
  initial_state: 'on'
  trigger:
    platform: time
    at: '01:30:00'
  action:
    - service: shell_command.backup_ha_and_move_backup_to_unraid
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'גיבוי'#backup
        message: 'הגיבוי היומי להום-אסיסטנט בביצוע בדוק סיום תקין בבוקר '    #daily backup of hass configis runing
        data:
          attachment: 
            url: https://i.imgur.com/a6TFrE1.png
            #https://d33wubrfki0l68.cloudfront.net/b1c67285b113e40ab92d0136aed5c79f3d3ceb17/69117/images/screenshots/ui2015.png
# ###################################################
# #                                                  #
# # Run the script Weekly to backup all OS (move the img proxmox made and save ha config in server)
# #                                                  #
# ####################################################
# - alias: 'Weekly OS Backup' #TODO
#   initial_state: 'on'
#   trigger:
#     platform: time
#     at: '02:30:00'
#   condition:
#   - condition: time
#     weekday:
#       - wed #3 Tuesday at night
#       - sun #7 Saturday at night
#   action:
#     - service: shell_command.backup_ha_and_move_backup_to_unraid
#     - service: notify.eliran_ios_and_ipad_and_telegram
#       data:
#         title: 'גיבוי'#backup
#         message: 'הגיבוי השבועי לכלל המערכת בפעולה! בדוק סיום תקין בבוקר,בקבצי השרת'   #Backup For all the os is in prograss
#         data:
#           attachment: 
#             url: https://i.imgur.com/M9d07WE.png
#             #https://www.bullten.com/img/icon/weekly-backup.png

###################################################
#                                                  #
# UpdateMyDNS
#                                                  #
####################################################  
#when my public ip been changed , update the ip in cloudflare and send me Notification
# - alias: IP Address Update
#   hide_entity: true
#   initial_state: true
#   trigger: #if the ip changed - trigger
#     - platform: state
#       entity_id: sensor.myipopendnscom
#   action:
#     - service: cloudflare.update_records #update my DNS
#     - service: notify.eliran_ios_and_ipad_and_telegram
#       data:
#         title: מצב רשת #Your Public IP has changed to
#         message: "האייפי החיצוני שונה ל: {{ states.sensor.myipopendnscom.state }}"
#         data:
#           attachment: 
#             url: https://images-na.ssl-images-amazon.com/images/I/519-zNN1sCL.png
            
#     - service: persistent_notification.create
#       data_template:
#         title: '{{ as_timestamp(now()) | timestamp_custom("%H:%M:%S", true) }}:עדכון'
#         message: '{{ states.sensor.myipopendnscom.state }} האייפי החיצוני השתנה, כרגע הוא'  #"Your public IP has changed, and is currently {{ states.sensor.myipopendnscom.state }}"
#         notification_id: IP Address Update
#####################################################
##                                                  #
## The air conditioner is ON and nobody at home -alert to turn it off
##                                                  #
#####################################################
- alias: 'The air conditioner is ON and nobody at home'  # ? check if is working without states 100% #winter???
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: climate.living_room 
      to: 'cool'
      for:
        minutes: 20
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'התראה'
      message: 'שכחת את המזגן דלוק! האם לכבות?'
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Turning-Off-The-Air-Conditioner.wav"
          badge: 0
          category: 'modifyaircon' #the ID
        attachment: 
          url: https://i.imgur.com/BGL6Udp.png
          #http://www.giersnet.pl/wp-content/uploads/2018/01/klima.png        

#####################################################
##                                                  #
## Some of the MAIN containers are OFF Alert
##                                                  #
#####################################################
- alias: 'Some of the MAIN containers are OFF Alert'
  initial_state: 'on'
  trigger:
    platform: state #OR State (if one of this switch will turn off , the alert will made)
    entity_id: switch.ha_dockermon_mosquitto,switch.ha_dockermon_letsencrypt,switch.ha_dockermon_unifi
    #switch.ha_dockermon_unms, switch.ha_dockermon_cloud9ide 
    to: 'off'  
    for:
      minutes: 5
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram #mobile_app_eliran_iphone
      data:
        title: 'מצב השרת'   #securty
        message: 'חלק מהקונטיינרים החשובים לעבודה תקינה של המערכת, כבויים בדוק את הסיבה'
        data:
          attachment: 
            url: https://i.imgur.com/0IRKbmi.gif
            #https://cdn-images-1.medium.com/max/1200/1*6aiG8217Vy9kEpF5k9ag4Q.gif
##############################################################################   
#
# Virtual Machine is OFF alert
#
##############################################################################   
- alias: 'Virtual Machine is OFF alert'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: device_tracker.windows_vm #serverpc Eliran
    to: 'not_home'
    for:
      minutes: 3
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'אבטחה'
      message: ' Blue Iris לא פעילה , בדוק תקינות המערכת הוירטואלית '
      data:
        attachment: 
          url: https://i.imgur.com/rflw5ZU.png
          #http://blueirissoftware.com/media/Download_03.png
          
          
##############################################################################   
#
# Virtual Machine is Back Online alert
#
##############################################################################   
- alias: 'Virtual Machine is Back Online alert'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: device_tracker.windows_vm #serverpc Eliran
    from: 'not_home'
    to: 'home'
    for:
      minutes: 5
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'אבטחה'
      message: ' Blue Iris חזרה לפעילות , בדוק זמינות בממשק '
      data:
        attachment: 
          url: https://i.imgur.com/rflw5ZU.png

##############################################################################   
#
# RDP port is Open alert
#
##############################################################################   
- alias: 'RDP port is Open alert'  # TODO make it repeate , to be not ignored
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.windows_rdp_port
    to: 'on'
    for:
      minutes: 45
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'אבטחה'
      message: ' פורט שולחן  פתוח! נא סגור אותו ידנית אם אין שימוש '
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Setting-The-Mood.wav"
          badge: 0
          category: 'close_rdp_port' #the indentefier      
        attachment: 
          url: https://i.imgur.com/REHcU44.png


##############################################################################   
#
# RDP port is Open alert
#
##############################################################################   
- alias: 'VPN Docker is Open alert'  # TODO make it repeate , to be not ignored
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.ha_dockermon_openvpn_as
    to: 'on'
    for:
      minutes: 45
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'אבטחה'
      message: 'VPN  פתוח , סגור אותו אם אין צורך '
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Setting-The-Mood.wav"
          badge: 0
          category: 'close_vpn_docker' #the indentefier      
        attachment: 
          url: https://i.imgur.com/REHcU44.png 

##############################################################################   
#
# iPad is offline alert
#
##############################################################################   
- alias: 'iPad is offline alert'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: device_tracker.homeipad 
    to: 'not_home'
    for:
      minutes: 5
  action:
    service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'HomeKit'
      message: 'האייפד לא מחובר לרשת! לכן אין גישה להוםקיט מחוץ לבית'
      data:
        attachment: 
          url: https://i.imgur.com/u0lVY15.png
          #https://cdn.vox-cdn.com/uploads/chorus_image/image/56018769/homekit_large.0.png

          
#############################################################################   
#
# Turn-ON Salon light 
#
#############################################################################   
- alias: "Dog at Home Lights"
  initial_state: 'on'
  trigger:
  - platform: sun
    event: sunset
    offset: '+00:30:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
  action:
  - service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'תאורה'  #Security
      message: 'זורו לבד בבית ,הודלקה תאורת סלון שמאל'
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Turning-On-The-Mood-Lights.wav"
          badge: 0
          category: 'modifymylights' #the indentefier
        attachment: 
          url: https://i.imgur.com/SohwJ6w.gif
          #https://media.tenor.com/images/dde7e721dd7129d019a72ba9a98e6cc6/tenor.gif
          #http://homeli.co.uk/wp-content/uploads/2015/05/Dog-Interacting-with-the-Flyte-Levitating-Light.gif
  - service: light.turn_on
    data_template:
      entity_id: light.white_bulb
      
      
#############################################################################   
#
# Turn-ON Salon light By action notification O
#
#############################################################################   
- alias: "ask for start vacuum cleaner at 2PM"
  initial_state: 'on'
  trigger:
    platform: time
    at: '14:00:00'
    # When 'at' is used, you cannot also match on hour, minute, seconds.
    # Military time format.
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
  action:
  - service: notify.eliran_ios_and_ipad_and_telegram
    data:
      title: 'שואב אבק'  #vacuum cleaner
      message: 'אף אחד לא בבית , האם להפעיל שואב אבק?'
      data:
        push:
          sound: "US-EN-Morgan-Freeman-Setting-The-Mood.wav"
          badge: 0
          category: 'vaccum_cleaner' #the indentefier
        attachment: 
          url: https://i.imgur.com/p2DJQkT.gif

#####################################################
##                                                  #
## The Boiler is ON and nobody at home -alert to turn it off
##                                                  #
#####################################################
- alias: 'The Boiler is ON and nobody at home'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.mqtt_pow1
    to: 'on'
    for:
      minutes: 10
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.eliran_iphone_wifi
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.shiran_iphone_wifi #shiran
        state: 'not_home'
      - condition: numeric_state
        entity_id: 'sensor.pow1_current' 
        above: 5 #amper        
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'התראה' #alert
        message: 'שכחת את הדוד דלוק! האם לכבות?'
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier 
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif

#####################################################
##                                                  #
## The Boiler is ON and physically "off" by the switch
##                                                  #
#####################################################
- alias: 'The Boiler is ON and physically off alert'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.pow1_current
    below: 5 #amper
  condition:
    - condition: state
      entity_id: 'switch.mqtt_pow1'
      state: 'on'
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'התראה' #alert
        message: 'הדוד דלוק, אך מנותק מהזרם,האם לכבות?'
        data:
          push:
            badge: 0
            category: 'modifymyboilerswitch' #the indentefier
          attachment: 
            url: https://i.imgur.com/igtwFWz.gif
#####################################################
##                                                  #
## Notify if the database is High                   #
##                                                  #
#####################################################
- alias: 'Database usage alert'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.home_assistant_v2_db
    above: 800
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'התראה' #alert
        message: 'גודל הדאטה-בייס מעל 800 מגה'
        data:
          attachment: 
            url: https://i.imgur.com/rvBlPPV.png

#####################################################
##                                                  #
## main hard disk usage alert                       #
##                                                  #
#####################################################
- alias: 'main hard disk usage alert'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.main_hdd_usage
    above: 80
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'התראה' #alert
        message: 'ניצול הדיסק הראשי מעל 80 אחוז!'
        data:
          attachment: 
            url: https://i.imgur.com/aIFAfBY.gif
#####################################################
##                                                  #
## SSD cache usage alert                            #
##                                                  #
#####################################################
- alias: 'SSD cache usage alert'
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.ssd_usage
    above: 80
  action:
    - service: notify.eliran_ios_and_ipad_and_telegram
      data:
        title: 'התראה' #alert
        message: 'ניצול דיסק ססדי מטמון מעל 80 אחוז!'
        data:
          attachment: 
            url: https://i.imgur.com/bnPrwki.png
####################################################
#                                                  #
# Dog walk restart timer
#                                                  #
####################################################
- alias: 'Dog walk started'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_main_entrance
    to: 'off'
  action:
    - service: timer.cancel
      entity_id: timer.dogwalk
    - service: timer.start
      entity_id: timer.dogwalk
      
      
###################################################
#                                                  #
# Telegram ad iOS Notify exemples
#                                                  #
####################################################     
    # - service: notify.eliran_telegram
    #   data:
    #     title: 'System info'
    #     message: 'Home Assistant is Up and Running.'
    #     data:
    #       photo:
    #         - file: /home/homeassistant/.homeassistant/tmp/home_cctv1.png
    #           caption: '{{now().strftime("%Y.%m.%d-%H:%M:%S")}}'
    #         - url : https://community-home-assistant-assets.s3-us-west-2.amazonaws.com/original/2X/6/6a99ebb8d0b585a00b407123ff76964cb3e18780.png
    #           caption: 
    #     # data: {"icon":"https://cdn4.iconfinder.com/data/icons/weather-conditions/512/low_temperature-512.png"}

    # - service: notify.mobile_app_eliran_iphone
    #   data:
    #     title: "System info"
    #     message: 'Home Assistant is Up and Running.'
    #     data:
    #       attachment: 
    #         url: https://community-home-assistant-assets.s3-us-west-2.amazonaws.com/original/2X/6/6a99ebb8d0b585a00b407123ff76964cb3e18780.png

##################################################################################################################################################
################## iOS notification actions ######################################################################################################
##################################################################################################################################################
####################################################
#                                                  #
# iOS notification action FOR LIGHTS!
#                                                  #
####################################################
- alias: 'iOS notification action ALLMYLIGHTS_OFF'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ALLMYLIGHTS_OFF #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: group.AllMylights

- alias: 'iOS notification action ONLY_KITCHEN_LIGHT_ON '
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ONLY_KITCHEN_LIGHT_ON #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: group.AllMylights
    - service: homeassistant.turn_on
      entity_id: light.kitchen

- alias: 'iOS notification action ONLY_GATEWAY_LIGHT_ON'
  initial_state: 'on' 
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ONLY_GATEWAY_LIGHT_ON #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: group.AllMylights
    - service: homeassistant.turn_on
      entity_id: light.gateway_light
- alias: 'iOS notification action ONLY_SALON_R_LIGHT_ON ' #Right Bulb only
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ONLY_SALON_R_LIGHT_ON #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: group.AllMylights
    - service: homeassistant.turn_on
      entity_id: light.living_room_color_bulb
      
      
####################################################
#                                                  #
# iOS notification action FOR CAMERAS
#                                                  #
####################################################
- alias: 'iOS notification action ALLMYCCTV_INHOME_OFF'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ALLMYCCTV_INHOME_OFF #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: switch.mqtt_pow2
    - service: homeassistant.turn_off
      entity_id: switch.sonoff_xiaomicctv_switch

- alias: 'iOS notification action CCTV_KITCHEN_ON'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: CCTV_KITCHEN_ON #the action that was tap
  action:
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow2

- alias: 'iOS notification action CCTV_XIAOMI_ON'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: CCTV_XIAOMI_ON #the action that was tap
  action:
    - service: homeassistant.turn_on
      entity_id: switch.sonoff_xiaomicctv_switch

- alias: 'iOS notification action ALLMYCCTV_INHOME_ON'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: ALLMYCCTV_INHOME_ON #the action that was tap
  action:
    - service: homeassistant.turn_on
      entity_id: switch.sonoff_xiaomicctv_switch
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow2
####################################################
#                                                  #
# iOS notification action FOR BOILER
#                                                  #
####################################################
- alias: 'iOS notification action BOILER_OFF'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: BOILER_OFF #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: group.boiler_setup


- alias: 'iOS notification action BOILER_ON'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: BOILER_ON #the action that was tap
  action:
    - service: homeassistant.turn_on
      entity_id: switch.mqtt_pow1

- alias: 'iOS notification action BOILER_ON_BY_TIMER'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: BOILER_ON_BY_TIMER #the action that was tap
  action:
    - service: homeassistant.turn_on
      entity_id: group.boiler_setup


######################################################
- alias: 'iOS notification action RESETHA'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: RESETHA #the action that was tap
  action:
  - service: homeassistant.restart

####################################################
#                                                  #
# iOS notification action VACCUM CLEANER !
#                                                  #
####################################################
- alias: 'iOS notification action START_VACCUM_CLEANER'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: START_VACCUM_CLEANER #the action that was tap
  action:
    - service: vacuum.start
      entity_id: vacuum.xiaomi_vacuum
####################################################
- alias: 'iOS notification action STOP_VACCUM_CLEANER'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: STOP_VACCUM_CLEANER #the action that was tap
  action:
    - service: vacuum.stop
      entity_id: vacuum.xiaomi_vacuum
####################################################
- alias: 'iOS notification action RETURN_TO_BASE_VACCUM_CLEANER'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: RETURN_TO_BASE_VACCUM_CLEANER #the action that was tap
  action:
    - service: vacuum.return_to_base
      entity_id: vacuum.xiaomi_vacuum
####################################################
- alias: 'iOS notification action CLOSE_RDP'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: CLOSE_RDP_PORT #the action that was tap
  action:
    - service: script.turn_on
      entity_id: script.close_rdp_port
####################################################
- alias: 'iOS notification action CLOSE_VPN_DOCKER'
  initial_state: 'on'
  hide_entity: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: CLOSE_VPN_DOCKER #the action that was tap
  action:
    - service: homeassistant.turn_off
      entity_id: switch.ha_dockermon_openvpn_as
# # # When timer is stopped, the time run out, another message is sent
# # - action:
# #  - service: notify.eliran_ios_and_ipad_and_telegram
# #     data:
# #       message: 'טיימר טיול כלב נגמר!'
# #       title: "טיימר" 
# #   alias: Dog walk timer stop
# #   id: 'Timerstop'
# #   trigger: 
# #     platform: event
# #     event_type: timer.finished
# #     event_data: 
# #       entity_id: timer.dogwalk 


    # - service: mqtt.publish 
    #   data:
    #     topic: "cmnd/sonoffs/power1" #Update the power state of all the sonoffs
    #     payload: ""
    

#####
#### Living room AC
####
###AC MODE update
# - alias: 'Living room AC Mode was changed update sensibo_living_room_operation'
#   initial_state: 'on'
#   trigger:
#     platform: state
#     entity_id: climate.living_room
#     #to: Any Change ["dry","auto","heat","fan_only","cool"]
#   action:   
#     - service: input_select.select_option
#       data_template:
#         entity_id: input_select.sensibo_living_room_operation
#         option: >
#           {% if is_state('climate.living_room', 'dry') %}
#             dry
#           {% elif is_state('iclimate.living_room', 'auto') %}            
#             auto
#           {% elif is_state('climate.living_room', 'heat') %}            
#             heat   
#           {% elif is_state('climate.living_room', 'fan_only') %}            
#             fan_only                      
#           {% else %}
#             cool
#           {% endif %}        
###AC MODE input_select CHANGED
- alias: 'input_select Living sensibo_living_room_operation changed'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: input_select.sensibo_living_room_operation 
    #to Anyone   
  action:
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.living_room
        operation_mode: >
          {% if is_state('input_select.sensibo_living_room_operation', 'dry') %}
            dry
          {% elif is_state('input_select.sensibo_living_room_operation', 'auto') %}            
            auto
          {% elif is_state('input_select.sensibo_living_room_operation', 'heat') %}            
            heat   
          {% elif is_state('input_select.sensibo_living_room_operation', 'fan_only') %}            
            fan_only                      
          {% else %}
            cool
          {% endif %}
### AC FAN UPDATE
# - alias: 'Living room AC FAN was changed update select_option'
#   initial_state: 'on'
#   trigger:
#     platform: state
#     entity_id: climate.living_room
#   action:
#     - service: input_select.select_option
#       data_template:
#         entity_id: input_select.sensibo_living_room_fan
#         option: >
#           {% if is_state_attr('climate.living_room', 'fan_mode', 'low') %}
#             low
#           {% elif is_state_attr('climate.living_room', 'fan_mode', 'medium') %}
#             medium
#           {% elif is_state_attr('climate.living_room', 'fan_mode', 'high') %}
#             high                               
#           {% else %}
#             auto
#           {% endif %}        

###AC FAN input_select CHANGED
- alias: 'input_select Living sensibo_living_room_fan changed'
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: input_select.sensibo_living_room_fan 
    #to Anyone   
  action:
    - service: climate.set_fan_mode
      data_template:
        entity_id: climate.living_room
        fan_mode: >
          {% if is_state('input_select.sensibo_living_room_fan', 'low') %}
            low
          {% elif is_state('input_select.sensibo_living_room_fan', 'medium') %}            
            medium
          {% elif is_state('input_select.sensibo_living_room_fan', 'high') %}            
            high                   
          {% else %}
            auto
          {% endif %}

